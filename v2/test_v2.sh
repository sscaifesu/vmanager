#!/bin/bash
# VM Manager v2.0 功能测试脚本

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║                   VM Manager v2.0 功能测试                        ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""

# 检查程序是否存在
if [ ! -f "./vm_manager_v2" ]; then
    echo "❌ 错误：vm_manager_v2 不存在"
    echo "请先编译: gcc -Wall -Wextra -O2 -std=c11 -o vm_manager_v2 vm_manager_v2.c"
    exit 1
fi

echo "✅ 程序文件存在"
echo ""

# 测试 1: 帮助信息
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 1: 帮助信息"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
./vm_manager_v2 --help | head -20
echo ""

# 测试 2: 版本信息
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 2: 版本信息"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
./vm_manager_v2 --version
echo ""

# 测试 3: 短选项
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 3: 短选项"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "$ ./vm_manager_v2 -h"
./vm_manager_v2 -h | head -5
echo ""
echo "$ ./vm_manager_v2 -V"
./vm_manager_v2 -V | head -3
echo ""

# 测试 4: 命令语法
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 4: 命令语法检查"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

echo "测试无效命令:"
./vm_manager_v2 invalid 2>&1 | head -2
echo ""

echo "测试缺少 VMID:"
./vm_manager_v2 start 2>&1 | head -2
echo ""

echo "测试无效 VMID:"
./vm_manager_v2 start abc 2>&1 | head -2
echo ""

# 测试 5: 文件大小
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 5: 程序信息"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
ls -lh vm_manager_v2
echo ""

# 总结
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ 所有测试完成！"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "下一步:"
echo "  1. 使用 sudo 测试实际 VM 操作"
echo "  2. 运行: sudo ./vm_manager_v2 list"
echo "  3. 安装: sudo make -f Makefile.v2 install"
